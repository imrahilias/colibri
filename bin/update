#!/bin/zsh
# backup stray config files
autoload colors; colors

if [[ $UID = 0 || $EUID = 0 ]]; then
    echo "$fg_bold[blue]::$fg_bold Root access detected, shutting down. $reset_color"
    exit 1
fi

case $(hostname) in
    archaeopteryx)
        files=(
            "/etc/pacman.d/hooks/nvidia.hook"
            "/etc/rsnapshot.conf"
            "/etc/systemd/system/rsnapshot-daily.timer"
            "/etc/systemd/system/rsnapshot-hourly.timer"
            "/etc/systemd/system/rsnapshot-monthly.timer"
            "/etc/systemd/system/rsnapshot-weekly.timer"
            "/etc/systemd/system/rsnapshot@.service"
        )
        ;;
    colibri)
        ;;
esac

files+=(
    "/boot/loader/entries/"*".conf"
    "/boot/loader/loader.conf"
    "/etc/X11/xorg.conf.d/70-synaptics.conf"
    "/etc/fstab"
    "/etc/gdm/custom.conf"
    "/etc/lostfiles.conf"
    "/etc/mkinitcpio.conf"
    "/etc/modprobe.d/blacklist.conf"
    "/etc/pacman.conf"
    "/etc/pacman.d/hooks/xkeyboard-config.hook"
    "/etc/pacman.d/hooks/zsh.hook"
    "/etc/pam.d/login"
    "/etc/pam.d/system-auth"
    "/etc/pam.d/system-local-login"
    "/etc/pam.d/system-login"
    "/etc/pam.d/xsecurelock"
    "/etc/profile"
    "/etc/security/limits.conf"
    "/etc/systemd/system/kill-printd.service"
    "/etc/systemd/system/user.slice"
    "/etc/systemd/system/x11-autologin.service"
    "/usr/share/xdg-desktop-portal/gnome-portals.conf"
    "/usr/share/xdg-desktop-portal/gtk-portals.conf"
    "/usr/share/xdg-desktop-portal/portals/darkman.portal"
    "/usr/share/xdg-desktop-portal/portals/gnome-keyring.portal"
    "/usr/share/xdg-desktop-portal/portals/gnome.portal"
    "/usr/share/xdg-desktop-portal/portals/gtk.portal"
    "/usr/share/xsessions/awesome.desktop"
)


loc="$HOME/.$(hostname)"
echo "$fg_bold[blue]:: $fg_bold[default]Running on $loc $reset_color"

echo "$fg_bold[blue]:: $fg_bold[default]Archive /boot,/etc,/usr. $reset_color"
for file in "${files[@]}"; do
    cp --parents --verbose "/$file" "$loc/"
done
sudo cp --parents --verbose "/var/lib/AccountsService/users/m" "$loc/"

# https://wiki.archlinux.org/index.php/System_maintenance
# https://wiki.archlinux.org/index.php/Pacman/Tips_and_tricks

echo "$fg_bold[blue]:: $fg_bold[default]Clear local cache. $reset_color"
echo "   rm -rf $HOME/.cache/"
rm -rf "$HOME/.cache/"

echo "$fg_bold[blue]:: $fg_bold[default]Backup the local pacman database. $reset_color"
echo "   tar -cjf $HOME/archive/pacman_database.tar.bz2 /var/lib/pacman/local"
tar -cjf $HOME/archive/pacman_database.tar.bz2 /var/lib/pacman/local

echo "$fg_bold[blue]:: $fg_bold[default]Keep a list of explicitly installed packages. $reset_color"
echo "   pacman -Qqe > $HOME/asc/archive/installed_packages"
pacman -Qqe > $HOME/asc/archive/installed_packages
echo "   $(wc -l < $HOME/asc/archive/installed_packages) packages installed"

echo "$fg_bold[blue]:: $fg_bold[default]Keep a list of manually installed packages (aur). $reset_color"
echo "   pacman -Qm > $HOME/.$(hostname)/installed_packages_manually"
pacman -Qm > $HOME/.$(hostname)/installed_packages_manually
echo "   $(wc -l < $HOME/.$(hostname)/installed_packages_manually) packages manually installed"

echo "$fg_bold[blue]:: $fg_bold[default]Copy zsh history to asc. $reset_color"
cp --parents --verbose "$HOME/.histfile" "$HOME/asc/archive/"

echo "$fg_bold[blue]:: $fg_bold[default]Reset antidote (git clones live in cache). $reset_color"
source '/usr/share/zsh-antidote/antidote.zsh' && antidote load

exit 0
